






<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#FFFFFF" />
  
  <title>Diary of a Game: Part 4 - Item Activation, Interpolation and... Bugs &middot; Ziggurat</title>
    <meta name="title" content="Diary of a Game: Part 4 - Item Activation, Interpolation and... Bugs &middot; Ziggurat" />
  
  
  
  
  
  <script
    type="text/javascript"
    src="https://ziggurat.co.nz/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js"
    integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="
  ></script>
  
  
  
  
  
  
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="https://ziggurat.co.nz/css/main.bundle.min.57d1c448a1783097815ad61ba1a727b1490184aed782150f83eb9243809e8142.css"
    integrity="sha256-V9HESKF4MJeBWtYboacnsUkBhK7XghUPg&#43;uSQ4CegUI="
  />
  
  
  
    
    
  
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="https://ziggurat.co.nz/js/main.bundle.min.3e80d0528c59616e7de9b0ca9316d9afd314b49ed9e5e6b88873731486ad67ee.js"
      integrity="sha256-PoDQUoxZYW596bDKkxbZr9MUtJ7Z5ea4iHNzFIatZ&#43;4="
      data-copy="Copy"
      data-copied="Copied"
    ></script>
  
  
  <meta
    name="description"
    content="
      
        
      
    "
  />
  
  
  
  
    <link rel="canonical" href="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/" />
  
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/">
  <meta property="og:site_name" content="Ziggurat">
  <meta property="og:title" content="Diary of a Game: Part 4 - Item Activation, Interpolation and... Bugs">
  <meta property="og:description" content="Occasional ramblings about retro games, development, augmented reality and other random subjects.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-02-24T00:46:02+00:00">
    <meta property="article:modified_time" content="2019-02-24T00:46:02+00:00">
    <meta property="article:tag" content="C64">
    <meta property="article:tag" content="Coding">
    <meta property="article:tag" content="Assembler">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Diary of a Game: Part 4 - Item Activation, Interpolation and... Bugs">
  <meta name="twitter:description" content="Occasional ramblings about retro games, development, augmented reality and other random subjects.">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "",
    "name": "Diary of a Game: Part 4 - Item Activation, Interpolation and... Bugs",
    "headline": "Diary of a Game: Part 4 - Item Activation, Interpolation and... Bugs",
    
    
    "inLanguage": "en",
    "url" : "https:\/\/ziggurat.co.nz\/news\/2019\/2\/24\/diary-of-a-game-part-4-item-activation-interpolation-and-bugs\/",
    "author" : {
      "@type": "Person",
      "name": "Michael Keith"
    },
    "copyrightYear": "2019",
    "dateCreated": "2019-02-24T00:46:02\u002b00:00",
    "datePublished": "2019-02-24T00:46:02\u002b00:00",
    
    "dateModified": "2019-02-24T00:46:02\u002b00:00",
    
    "keywords": ["c64","Coding","Assembler"],
    
    "mainEntityOfPage": "true",
    "wordCount": "918"
  }
  </script>
    
    <script type="application/ld+json">
    {
   "@context": "https://schema.org",
   "@type": "BreadcrumbList",
   "itemListElement": [
     {
       "@type": "ListItem",
       "item": "https://ziggurat.co.nz/",
       "name": "Welcome to Ziggurat",
       "position": 1
     },
     {
       "@type": "ListItem",
       "item": "https://ziggurat.co.nz/posts/",
       "name": "",
       "position": 2
     },
     {
       "@type": "ListItem",
       "item": "https://ziggurat.co.nz/categories/diary-of-a-game/",
       "name": "Diary of a Game",
       "position": 3
     },
     {
       "@type": "ListItem",
       "name": "Diary of a Game Part 4 Item Activation, Interpolation And... Bugs",
       "position": 4
     }
   ]
 }
  </script>

  
  
    <meta name="author" content="Michael Keith" />
  
  
    
      <link href="mailto:mike@ziggurat.co.nz" rel="me" />
    
      <link href="https://github.com/mikekeith" rel="me" />
    
      <link href="https://lastfm.com/user/nifta" rel="me" />
    
      <link href="https://icosahedron.website/@nifta" rel="me" />
    
  
  
  







  
  
  
  
  
  


  
  
    <meta name="omgproof" content="proven.lol/df002d">
  
</head>
<body
    class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="flex flex-row items-center">
      
    <a href="/" class="mr-2">
      
      <img
        src="https://ziggurat.co.nz/images/Ziggurat%20Logo%20Symbol%2064x64.png"
        width="32"
        height="32"
        class="max-h-[10rem] max-w-[10rem] object-scale-down object-left
        "
        alt="Ziggurat"
      />
    </a>
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >Ziggurat</a
  >

    </div>
    
    
      <ul class="flex list-none flex-col text-end sm:flex-row">
        
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/about/"
                  title="About"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >About</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/posts/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Blog</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/categories/"
                  title="Categories"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Categories</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/tags/"
                  title="Tags"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Tags</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/confidential/"
                  title="Confidential Magazine"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Confidential Magazine</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                
                
              
            </li>
          
            
              
          
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex grow flex-col">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
        <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="https://ziggurat.co.nz/"
      >Welcome to Ziggurat</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class=" inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="https://ziggurat.co.nz/posts/"
      >posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/"
      >Diary of a Game: Part 4 - Item Activation, Interpolation and... Bugs</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


      
      <h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Diary of a Game: Part 4 - Item Activation, Interpolation and... Bugs
      </h1>
      
        <div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
          





  
  



  

  
  
    
  

  

  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2019-02-24 00:46:02 &#43;0000 &#43;0000">24 February 2019</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">5 mins</span>
    

    
    
  </div>

  
  
    <div class="my-1 flex flex-wrap text-xs leading-relaxed text-neutral-500 dark:text-neutral-400">
      
        
          
            <a
              href="https://ziggurat.co.nz/categories/diary-of-a-game/"
              class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >Diary of a Game</a
            >
          
        
      
        
          
            <a
              href="https://ziggurat.co.nz/tags/c64/"
              class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >C64</a
            >
          
            <a
              href="https://ziggurat.co.nz/tags/coding/"
              class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >Coding</a
            >
          
            <a
              href="https://ziggurat.co.nz/tags/assembler/"
              class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >Assembler</a
            >
          
        
      
    </div>
  


        </div>
      
      
    </header>
    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      
      <div class="min-h-0 min-w-0 max-w-prose grow">
        <p>Since my last update work has been a bit quieter post-ship and I enjoyed an
unexpectedly low key Christmas break, so surely I&rsquo;ve made a lot of progress,
right? Well&hellip; life decided to intervene which resulted in a lot less time to
work on the game than I had hoped. But I have managed to tick off a few things
on the long to-do list&hellip;</p>
<p>





<figure>
    
    








  
    <picture
      class="mx-auto my-0 rounded-md"
      
    >
      
      
      
      
      <img
        width="521"
        height="392"
        class="mx-auto my-0 rounded-md"
        
        loading="lazy" decoding="async"
        
          src="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/image-asset.gif"
        
      />
    </picture>
  


</figure>
</p>
<h2 id="item-activation" class="relative group">Item Activation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#item-activation" aria-label="Anchor">#</a></span></h2><p>The main - and, I must admit, only - playing facing addition is items that
need to be activated before they can be matched. Activation occurs when a
neighbour - regardless of colour - is matched and removed. I&rsquo;ve reserved the
4th bit to indicate whether an item requires activation, which means I have 7
possible item types. So far I&rsquo;m only using 4, so I <em>think</em> this will be
enough. However, I should be able to take the 5th bit to give 15 item types
(each with an unactivated variant) if need be.</p>
<p>The item bits at present are:</p>
<pre><code>.const ITEM_TYPE_BITS = %00001111
.const ITEM_AWAITING_ACTIVATION = %00001000
.const ITEM_MOVING = %00100000
.const ITEM_DONT_DRAW = %01000000

.enum {
    ITEM_TYPE_NONE = 0,
    ITEM_TYPE_WHITE_BALL = 1,
    ITEM_TYPE_RED_BALL = 2,
    ITEM_TYPE_CYAN_BALL = 3,
    ITEM_TYPE_PURPLE_BALL = 4,

    ITEM_TYPE_PLACEHOLDER_1 = 5,
    ITEM_TYPE_PLACEHOLDER_2 = 6,
    ITEM_TYPE_PLACEHOLDER_3 = 7,

    ITEM_TYPE_NONE_UNACTIVATED = ITEM_TYPE_NONE + ITEM_AWAITING_ACTIVATION,

    ITEM_TYPE_WHITE_BALL_UNACTIVATED = ITEM_TYPE_WHITE_BALL + ITEM_AWAITING_ACTIVATION,
    ITEM_TYPE_RED_BALL_UNACTIVATED = ITEM_TYPE_RED_BALL + ITEM_AWAITING_ACTIVATION,
    ITEM_TYPE_CYAN_BALL_UNACTIVATED = ITEM_TYPE_CYAN_BALL + ITEM_AWAITING_ACTIVATION,
    ITEM_TYPE_PURPLE_BALL_UNACTIVATED =ITEM_TYPE_PURPLE_BALL + ITEM_AWAITING_ACTIVATION,


    ITEM_NUM_TYPES = 13
}
</code></pre>
<h2 id="interpolation" class="relative group">Interpolation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#interpolation" aria-label="Anchor">#</a></span></h2><p>Up until a couple of months ago, the code to handle the sprite movement when
the player fires an item was specific to that use case. Rather than having
items jump immediately to their new positions when neighbours are removed, I
want to utilise this sprite iterpolation to make it nice and smooth. So the
first step in the process was to refactor the code into something more
generic.</p>
<p>The resulting routines are super simplistic - the interpolation speeds are
specified as pixels per update (whole pixels only), and the X and Y
coordinates are interpolated at the same speed, which doesn&rsquo;t look great under
some circumstances. I may revisit this in the future.</p>
<p>The following clip shows this code in action:</p>
<pre><code>test_lerp:
    :test_push_lerp(0, 0, 100, 200, 1)
    :test_push_lerp(200, 0, 50, 200, 2)
    :test_push_lerp(20, 0, 70, 200, 3)
    :test_push_lerp(60, 0, 40, 200, 4)
    :test_push_lerp(90, 0, 120, 200, 5)
    :test_push_lerp(0, 0, 100, 200, 1)
    :test_push_lerp(200, 0, 50, 200, 2)
    :test_push_lerp(20, 0, 70, 200, 3)
    :test_push_lerp(60, 0, 40, 200, 4)
    :test_push_lerp(90, 0, 120, 200, 5)

!loop:
    :start_frame_update(1, !profiling)
    jsr item_lerper.tick
</code></pre>
<p>where the test_push_lerp parameters are the start X &amp; Y, target X &amp; Y and
colour.</p>
<p>





<figure>
    
    








  
    <picture
      class="mx-auto my-0 rounded-md"
      
    >
      
      
      
      
      <img
        width="521"
        height="395"
        class="mx-auto my-0 rounded-md"
        
        loading="lazy" decoding="async"
        
          src="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/image-asset-1.gif"
        
      />
    </picture>
  


</figure>
</p>
<h2 id="bugs" class="relative group">Bugs <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#bugs" aria-label="Anchor">#</a></span></h2><p>While writing the activation and interpolation code, I ran into two separate
bugs that had me scatching my head for an embarassingly long time.</p>
<p>The first occurred when matched items were being removed - occasionally the
bottom left item would disappear when it shouldn&rsquo;t. I suspected this had
something to do with the new code which finds any neighbours of an item being
removed and activates them. The <a href="https://sourceforge.net/projects/c64-debugger/" target="_blank" rel="noreferrer">64 Debugger</a> was a huge help in
tracking the culprit down, especially since it recently added the ability to
read KickAssembler debug symbols. This is brilliant as it gives you your full
source code along side the instructions:</p>
<p>





<figure>
    
    








  
    <picture
      class="mx-auto my-0 rounded-md"
      
    >
      
      
      
      
        <source
          
            srcset="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-09-42_AM_hu_1307cb4e26095d9f.webp 330w,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-09-42_AM_hu_97aafe71ede005e1.webp 660w
            
              
                ,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-09-42_AM_hu_ea1505b526a8b982.webp 781w
              
            
            
              
                ,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-09-42_AM_hu_ea1505b526a8b982.webp 781w
              
            "
          
          sizes="100vw"
          type="image/webp"
        />
      
      <img
        width="781"
        height="504"
        class="mx-auto my-0 rounded-md"
        alt="Capto_Capture 2019-02-24_11-09-42_AM.png"
        loading="lazy" decoding="async"
        
          src="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-09-42_AM_hu_e9e80d5cd90ac2ed.png" srcset="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-09-42_AM_hu_7003ee410337417b.png 330w,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-09-42_AM_hu_e9e80d5cd90ac2ed.png 660w
          
            ,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-09-42_AM.png 781w
          
          
            ,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-09-42_AM.png 781w
          "
          sizes="100vw"
        
      />
    </picture>
  


</figure>
</p>
<p>





<figure>
    
    








  
    <picture
      class="mx-auto my-0 rounded-md"
      
    >
      
      
      
      
        <source
          
            srcset="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-11-43_AM_hu_85c9410bd56f82e7.webp 330w,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-11-43_AM_hu_cd82c470c899950e.webp 660w
            
              
                ,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-11-43_AM_hu_a91276e47d3f7b8.webp 781w
              
            
            
              
                ,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-11-43_AM_hu_a91276e47d3f7b8.webp 781w
              
            "
          
          sizes="100vw"
          type="image/webp"
        />
      
      <img
        width="781"
        height="504"
        class="mx-auto my-0 rounded-md"
        alt="Capto_Capture 2019-02-24_11-11-43_AM.png"
        loading="lazy" decoding="async"
        
          src="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-11-43_AM_hu_10d659d5fed7b98c.png" srcset="https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-11-43_AM_hu_49c18f7db73fa88.png 330w,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-11-43_AM_hu_10d659d5fed7b98c.png 660w
          
            ,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-11-43_AM.png 781w
          
          
            ,https://ziggurat.co.nz/news/2019/2/24/diary-of-a-game-part-4-item-activation-interpolation-and-bugs/Capto_Capture-2019-02-24_11-11-43_AM.png 781w
          "
          sizes="100vw"
        
      />
    </picture>
  


</figure>
</p>
<p>Sure enough the bug was in the routine to find occupied neighbours - if there
were no neighbours, I was neglecting to set the count of neighbours found to
zero. This meant it would try to activate whatever items happened to be lying
around in a buffer.</p>
<p>The second bug was considerably harder to find&hellip;</p>
<h2 id="the-perils-of-macros" class="relative group">The Perils of Macros <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#the-perils-of-macros" aria-label="Anchor">#</a></span></h2><p><a href="http://www.theweb.dk/KickAssembler/webhelp/content/cpt_Introduction.html" target="_blank" rel="noreferrer">KickAssembler</a> has a rich scripting language to assist with creating
code and data. For my first pass on the interpolation routines, I relied
heavily on the scripting - particularly macros and pseudocommands. This made
things like operating over a buffer of data structures very straightforward,
for example:</p>
<pre><code>.for (var i = 0; i &lt; lerping_items_count; i++) {
    lda lerping_items[i].active
    beq !skip+

    :lerp(lerping_items[i].current_x, lerping_items[i].target_x, ITEM_DROP_SPEED, lerping_items[i].active)
    :lerp(lerping_items[i].current_y, lerping_items[i].target_y, ITEM_DROP_SPEED, lerping_items[i].active)

    :update_lerping_item_sprite(i)
    ....
</code></pre>
<p>But then I ran into a bug where some interpolating items would just disappear
when a certain number had been queued. What made this particularly difficult
to debug was the reliance on macros and pseudocommands. Because I was calling
several macros, which in turn called other macros and pseudocommands, and all
of this was wrapped in a for loop, the amount of actual code output was huge.
I found stepping through all this code tedious and confusing - particularly
since the issue only appeared towards the end of the interpolating items
buffer.</p>
<p>The cause turned out to be a classic mixup between an address and the size of
a buffer. In the routine to find a free interpolating item to use, I loop over
all the items in the buffer to see if there is one that isn&rsquo;t active:</p>
<pre><code>get_free_lerping_item_offset:
    ldx #0
!loop:    
    lda lerping_items,X
    beq !found_free+

    txa
    clc    
    adc #lerping_item_size()
    cmp #lerping_items_end  // &lt;---- d'oh
    bcs !none_free+

    tax
    jmp !loop-
!found_free:
    rts
!none_free:
    ldx #255
    rts
</code></pre>
<p>lerping_items_end happens to be the memory <em>address</em> immediately after the
lerping items buffer. What I wanted, of course, was to compare the current
offset to the <em>size</em> of the buffer.</p>
<h2 id="kickassembler-5" class="relative group">KickAssembler 5 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#kickassembler-5" aria-label="Anchor">#</a></span></h2><p>As well as the ability to output full symbols/source for use in the <a href="https://sourceforge.net/projects/c64-debugger" target="_blank" rel="noreferrer">C64
Debugger</a>, there are a number of other <a href="http://www.theweb.dk/KickAssembler/Main.html#updates" target="_blank" rel="noreferrer">nice improvements</a> in
KickAssembler 5. However, the changes to escape characters in strings broke
the useful unit test framework <a href="https://github.com/64bites/64spec" target="_blank" rel="noreferrer">64spec</a>. I&rsquo;ve submitted a <a href="https://github.com/64bites/64spec/pull/4" target="_blank" rel="noreferrer">pull
request</a> that fixes these errors.</p>

      </div>
    </section>
    <footer class="max-w-prose pt-8 print:hidden">
      
  <div class="flex">
    
    
    
      
      
        
        








  
    
    
    
    
    
    
      
        
        
      
    
    
    
    <picture  class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full" >
      <img
        src="https://ziggurat.co.nz/images/Ziggurat%20Logo%20Symbol.svg"
        width="219"
        height="219"
        class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"
        alt="Michael Keith"
        loading="lazy" decoding="async"
      />
    </picture>
  


      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          Michael Keith
        </div>
      
      
        <div class="text-sm text-neutral-700 dark:text-neutral-400">Peregrinator</div>
      
      <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="mailto:mike@ziggurat.co.nz"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>
</span></a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="https://github.com/mikekeith"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="https://lastfm.com/user/nifta"
          target="_blank"
          aria-label="Lastfm"
          rel="me noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M225.8 367.1l-18.8-51s-30.5 34-76.2 34c-40.5 0-69.2-35.2-69.2-91.5 0-72.1 36.4-97.9 72.1-97.9 66.5 0 74.8 53.3 100.9 134.9 18.8 56.9 54 102.6 155.4 102.6 72.7 0 122-22.3 122-80.9 0-72.9-62.7-80.6-115-92.1-25.8-5.9-33.4-16.4-33.4-34 0-19.9 15.8-31.7 41.6-31.7 28.2 0 43.4 10.6 45.7 35.8l58.6-7c-4.7-52.8-41.1-74.5-100.9-74.5-52.8 0-104.4 19.9-104.4 83.9 0 39.9 19.4 65.1 68 76.8 44.9 10.6 79.8 13.8 79.8 45.7 0 21.7-21.1 30.5-61 30.5-59.2 0-83.9-31.1-97.9-73.9-32-96.8-43.6-163-161.3-163C45.7 113.8 0 168.3 0 261c0 89.1 45.7 137.2 127.9 137.2 66.2 0 97.9-31.1 97.9-31.1z"/></svg>
</span></a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="https://icosahedron.website/@nifta"
          target="_blank"
          aria-label="Mastodon"
          rel="me noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a
        >
      
    
  </div>

</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="https://ziggurat.co.nz/news/2019/1/24/this-month-in-the-one-93/">
              <span
                class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&larr;</span
                ><span class="ltr:hidden rtl:inline">&rarr;</span></span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >This month in... The One '93</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2019-01-24 06:32:46 &#43;0000 &#43;0000">24 January 2019</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="https://ziggurat.co.nz/news/2019/2/27/this-month-in-the-one-93/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >This month in... The One '93</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2019-02-27 07:59:35 &#43;0000 &#43;0000">27 February 2019</time>
                  
                </span>
              </span>
              <span
                class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&rarr;</span
                ><span class="ltr:hidden rtl:inline">&larr;</span></span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

      </main>
      
        <div
          class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"
          id="to-top"
          hidden="true"
        >
          <a
            href="#the-top"
            class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
            aria-label="Scroll to top"
            title="Scroll to top"
          >
            &uarr;
          </a>
        </div>
      <footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://github.com/jpanther/congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    <div class="flex flex-row items-center">
      
      
      
      
        <div
          class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        >
          <button id="appearance-switcher-0" type="button" aria-label="appearance switcher">
            <div
              class="flex h-12 w-12 items-center justify-center dark:hidden"
              title="Switch to dark appearance"
            >
              <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
            </div>
            <div
              class="hidden h-12 w-12 items-center justify-center dark:flex"
              title="Switch to light appearance"
            >
              <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
            </div>
          </button>
        </div>
      
    </div>
  </div>
  
  
</footer>

    </div>
  </body>
</html>
